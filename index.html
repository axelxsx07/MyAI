<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Chat IA - PastranaTechnology</title>
<style>
  html, body { margin: 0; padding: 0; height: 100%;
    background: radial-gradient(circle at center, #0f0f23, #000010);
    color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding-bottom: env(safe-area-inset-bottom);
  }
  .app-container { display: flex; height: 100vh; position: relative; }
  .sidebar {
    width: 280px; background: rgba(20,20,35,0.95);
    border-right: 1px solid #444654;
    position: absolute; left: -300px; top: 0; bottom: 0;
    display: flex; flex-direction: column;
    transition: left 0.4s ease; z-index: 2;
  }
  .sidebar.open { left: 0; animation: bubbleIn 0.4s ease forwards; }

  /* Nuevo estilo para el enlace Login in */
  .login-link {
    color: #1e90ff;
    text-decoration: underline;
    cursor: pointer;
    font-size: 0.50rem;
    padding: 0.5rem 0.5rem 0 0.5rem;
    user-select: none;
    align-self: flex-start;
  }
  .login-link:hover {
    color: #0a60d9;
  }

  .sidebar h2 {
    text-align: center; padding: 1rem; margin: 0;
    font-size: 1.2rem; border-bottom: 1px solid #444654;
  }
  .sidebar h2 img.header-logo {
    height: 1em;
    vertical-align: middle;
    margin-right: 0.4em;
    border-radius: 4px;
  }

  #chatList { list-style: none; padding: 0; margin: 0;
    flex-grow: 1; overflow-y: auto;
  }
  .sidebar li {
    padding: 0.75rem 1rem; cursor: pointer;
    border-bottom: 1px solid #333;
    animation: slideInLi 0.3s ease both;
  }
  .sidebar li.active {
    background-color: #333;
    border-left: 4px solid #1e90ff;
    padding-left: calc(1rem - 4px);
  }
  .new-chat {
    padding: 1rem; text-align: center; background: #1e1e2e;
    border-top: 1px solid #444654; cursor: pointer; font-weight: bold;
  }
  .new-chat.animated { animation: bubbleIn 0.3s ease; }

  .sidebar .footer {
    padding: 1rem; text-align: center; font-size: 0.85rem;
    color: #aaa; border-top: 1px solid #444654;
  }
  .footer img.footer-logo {
    height: 1em;
    vertical-align: middle;
    margin: 0 0.3em;
    border-radius: 4px;
  }

  .chat-area {
    flex-grow: 1; display: flex; flex-direction: column;
    height: 100vh; transition: margin-left 0.4s ease; margin-left: 0; z-index: 1;
  }
  .chat-area.shifted { margin-left: 280px; }
  .chat-header {
    padding: 1rem; background: #1a1a2f;
    display: flex; align-items: center; gap: 1rem;
    border-bottom: 1px solid #444654;
  }
  .chat-header h1 { font-size: 1.1rem; margin: 0; }
  /* Título editable con input */
  #chatTitle {
    background: transparent;
    border: none;
    color: #aaa;
    font-size: 0.95rem;
    flex-grow: 1;
    flex-shrink: 1;
    min-width: 0;
    max-width: 100%;
    cursor: default;
    user-select: text;
    outline: none;
  }
  #toggleSidebar {
    background: none; border: none; color: #fff;
    font-size: 1.5rem; cursor: pointer;
    transition: transform 0.3s;
  }
  #toggleSidebar.rotated { transform: rotate(90deg); }
  #conversation {
    flex-grow: 1; overflow-y: auto; padding: 1rem;
    padding-bottom: calc(4rem + env(safe-area-inset-bottom));
    display: flex; flex-direction: column; gap: 1rem;
    background: url("https://www.transparenttextures.com/patterns/cubes.png") repeat;
  }
  .message {
    max-width: 75%; padding: 1rem; border-radius: 20px;
    white-space: pre-wrap; line-height: 1.4;
    opacity: 0; transform: translateY(10px);
    animation: fadeIn 0.4s forwards;
  }
  .user { align-self: flex-end; background: #1e90ff; }
  .bot  { align-self: flex-start; background: #2e2e2e; }
  .input-area {
    position: fixed; bottom: 0; left: 0; right: 0;
    display: flex; padding: 1rem;
    padding-bottom: calc(1rem + env(safe-area-inset-bottom));
    border-top: 1px solid #444654; background: #111; z-index: 10;
    transition: left 0.4s ease;
    flex-direction: column;
  }
  .input-area.shifted { left: 280px; animation: bubbleIn 0.4s ease forwards; }

  /* Cards burbujas independientes horizontales arriba, fuera de la barra enviar */
  #modeSelector {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 24px; /* bajamos un poco las cards para no chocarlas */
    flex-wrap: nowrap;
    overflow-x: auto;
    padding-left: 1rem;
  }

  .modeCard {
    padding: 5px 12px;
    border-radius: 20px;
    border: 2px solid #1e90ff;
    cursor: pointer;
    user-select: none;
    font-weight: 600;
    background-color: transparent;
    font-size: 0.85rem;
    white-space: nowrap;
    transition: all 0.3s ease;
    flex-shrink: 0;
  }

  .modeCard.selected {
    background-color: #1e90ff;
    color: white;
    animation: bubbleIn 0.3s ease forwards;
  }

  .input-row {
    display: flex;
    gap: 8px;
    align-items: flex-end;
    position: relative;
  }

  .textarea-wrapper {
    flex-grow: 1;
    position: relative;
    min-height: 30px;
  }

  #userInput {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    padding: 0.45rem 0.5rem 0.3rem; /* más padding inferior que superior */
    border-radius: 10px;
    border: none;
    font-size: 0.85rem;
    background: #222;
    color: #fff;
    resize: none;
    overflow-y: auto;        /* permite scroll si es necesario */
    line-height: 1.4;
    min-height: 36px;
    max-height: 120px;
    z-index: 20;
    box-sizing: border-box;
  }

  #sendBtn {
    height: 45px;               /* Altura igual a 2 renglones del textarea */
    padding: 0 1rem;            /* Solo padding horizontal */
    border-radius: 10px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    background: #1e90ff;
    color: #fff;
    transition: background-color 0.3s ease;
    width: 90px;
  }
  .input-area textarea::placeholder {
    color: #999;
  }
  .input-area input::placeholder { color: #999; }
  .input-area button {
    padding: 0.75rem 1rem; border-radius: 10px;
    border: none; font-weight: bold; cursor: pointer;
    background: #1e90ff; color: #fff;
    transition: background-color 0.3s ease;
    width: 90px;
  }
  .input-area button:hover:not(:disabled) { background: #0a60d9; }
  .input-area button:disabled { background: #555; cursor: not-allowed; }
  .chat-header {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 1rem;
    background: #1a1a2f;
    border-bottom: 1px solid #444654;
    flex-wrap: nowrap;
    overflow: hidden;
  }

  #menuBtn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4px;
    margin-left: auto;
    border-radius: 6px;
    transition: background 0.3s ease;
  }

  #menuBtn:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .menu-logo {
    height: 28px;
    width: 28px;
    border-radius: 6px;
  }

  @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
  @keyframes bubbleIn {
    0% { transform: scale(0.6); opacity: 0; }
    60% { transform: scale(1.05); opacity: 1; }
    100% { transform: scale(1); }
  }
  @keyframes slideInLi {
    from { transform: translateX(-20px); opacity: 0; }
    to   { transform: translateX(0);  opacity: 1; }
  }
  .typing {
    display: flex; gap: 6px; margin-left: 10px; align-items: center;
  }
  .typing span {
    width: 8px; height: 8px; background: #1e90ff;
    border-radius: 50%; animation: blink 1.4s infinite; opacity: 0.3;
  }
  .typing span:nth-child(1) { animation-delay: 0s; }
  .typing span:nth-child(2) { animation-delay: 0.2s; }
  .typing span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes blink {
    0%,80%,100% { opacity: 0.3; }
    40%         { opacity: 1;   }
  }
</style>
</head>
<body>
  <div class="app-container">
    <div class="sidebar" id="sidebar">
      <div id="loginArea">
        <a href="registro.html" class="login-link" target="_self" rel="noopener noreferrer">Login in</a>
      </div>
      <h2>
        <img src="https://raw.githubusercontent.com/axelxsx07/logo/main/2347FCDD-F04C-4C09-87F9-66069E2367B8.png" alt="logo" class="header-logo" />
        CHATS
      </h2>
      <ul id="chatList"></ul>
      <div class="new-chat" id="newChatBtn" onclick="newChat()">➕ Nuevo chat</div>
      <div class="footer">
        by: <img src="https://raw.githubusercontent.com/axelxsx07/logo/main/2347FCDD-F04C-4C09-87F9-66069E2367B8.png" alt="logo" class="footer-logo" /> PastranaTecnology
      </div>
    </div>
    <div class="chat-area" id="chatArea">
      <div class="chat-header">
        <button id="toggleSidebar">☰</button>
        <h1>BrainAI</h1>
        <input id="chatTitle" type="text" readonly title="No editable" />
        <a href="menu.html" id="menuBtn" title="Ir al menú">
          <img src="https://raw.githubusercontent.com/axelxsx07/logo/main/2347FCDD-F04C-4C09-87F9-66069E2367B8.png" alt="Menú" class="menu-logo" />
        </a>
      </div>
      <div id="conversation"></div>
      <div class="input-area">
        <div id="modeSelector">
          <div class="modeCard selected" data-mode="general">General</div>
          <div class="modeCard" data-mode="matematico">Matemático</div>
          <div class="modeCard" data-mode="cientifico">Científico</div>
          <div class="modeCard" data-mode="fisico">Físico</div>
          <div class="modeCard" data-mode="programador">Programador</div>
          <div class="modeCard" data-mode="quimico">Químico</div>
          <div class="modeCard" data-mode="lenguajes">Lenguajes</div>
        </div>
        <div class="input-row">
          <div class="textarea-wrapper">
            <textarea id="userInput" placeholder="Escribe tu mensaje..." rows="1"></textarea>
          </div>
          <button id="sendBtn" disabled>Enviar</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const sidebar    = document.getElementById('sidebar');
  const toggleBtn  = document.getElementById('toggleSidebar');
  const chatList   = document.getElementById('chatList');
  const conversation = document.getElementById('conversation');
  const userInput  = document.getElementById('userInput');
  const sendBtn    = document.getElementById('sendBtn');
  const chatArea   = document.getElementById('chatArea');
  const modeSelector = document.getElementById('modeSelector');
  const modeCards = modeSelector.querySelectorAll('.modeCard');
  const chatTitleInput = document.getElementById('chatTitle');
  const loginArea = document.getElementById('loginArea');

  let chats = [];
  let current = null;
  let selectedMode = 'general';

  toggleBtn.onclick = () => {
    const open = sidebar.classList.toggle('open');
    toggleBtn.classList.toggle('rotated', open);
    chatArea.classList.toggle('shifted', open);
    document.querySelector('.input-area').classList.toggle('shifted', open);
  };

  modeCards.forEach(card => {
    card.addEventListener('click', () => {
      if (!current || current.promptLocked) return; // No cambiar modo si ya está bloqueado

      modeCards.forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      selectedMode = card.dataset.mode;

      if (current) {
        current.mode = selectedMode;
      }
    });
  });

  async function generateTitle(chat) {
    try {
      const firstUserMessage = chat.msgs.find(m => m.sender === 'user');
      if (!firstUserMessage) return;

      const res = await fetch('/api/title', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: [firstUserMessage] })
      });
      const data = await res.json();
      if (!chat.title) {
        chat.title = data.title || '';
        renderList();
        render();
      }
    } catch (e) {
      console.error('Error generando título:', e);
    }
  }

  function newChat() {
    const n = { 
      title: '', 
      mode: selectedMode, 
      msgs: [{ text: '¡Hola! ¿Cómo puedo ayudarte?', sender: 'bot' }],
      promptLocked: false
    };
    chats.push(n);
    select(n);
    renderList();
    sidebar.classList.remove('open');
    toggleBtn.classList.remove('rotated');
    chatArea.classList.remove('shifted');
    document.querySelector('.input-area').classList.remove('shifted');
    const btn = document.getElementById('newChatBtn');
    btn.classList.add('animated');
    setTimeout(() => btn.classList.remove('animated'), 400);
    modeSelector.style.display = 'flex';
  }

  function select(c) {
    current = c;
    if (current.mode) {
      selectedMode = current.mode;
      modeCards.forEach(card => {
        card.classList.toggle('selected', card.dataset.mode === selectedMode);
      });
    }
    render();
    renderList();
    modeSelector.style.display = current.promptLocked ? 'none' : 'flex';
  }

  function renderList() {
    chatList.innerHTML = '';
    chats.forEach((c, i) => {
      const li = document.createElement('li');
      const nro = i + 1;
      li.textContent = c.title
        ? `Chat ${nro} - ${c.title}`
        : `Chat ${nro}`;
      li.className = '';
      if (c === current) li.classList.add('active');
      li.style.animationDelay = `${i * 0.05}s`;
      li.onclick = () => select(c);
      chatList.appendChild(li);
    });
  }

  // Función render() modificada para mostrar título guardado al cargar chats
  function render() {
    conversation.innerHTML = '';
    current.msgs.forEach(m => {
      const div = document.createElement('div');
      div.className = 'message ' + (m.sender === 'user' ? 'user' : 'bot');
      div.textContent = m.text;
      conversation.appendChild(div);
    });
    conversation.scrollTop = conversation.scrollHeight;
    sendBtn.disabled = false;
    const idx = chats.indexOf(current) + 1;

    // Mostrar el título original guardado si existe, o "Chat n" si no
    chatTitleInput.value = current.title !== '' ? current.title : `Chat ${idx}`;
    chatTitleInput.readOnly = true;
    chatTitleInput.style.cursor = 'default';
  }

  function setTyping(on) {
    if (on) {
      const d = document.createElement('div');
      d.className = 'typing';
      d.id = 'typing';
      d.innerHTML = '<span></span><span></span><span></span>';
      conversation.appendChild(d);
      conversation.scrollTop = conversation.scrollHeight;
      sendBtn.disabled = true;
    } else {
      const t = document.getElementById('typing');
      if (t) t.remove();
      sendBtn.disabled = false;
    }
  }

  sendBtn.onclick = async () => {
    const text = userInput.value.trim();
    if (!text || !current) return;
    current.msgs.push({ text, sender: 'user' });
    userInput.value = '';
    render();
    setTyping(true);

    if (!current.promptLocked) {
      current.promptLocked = true;
      modeSelector.style.display = 'none';
    }

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          chat_id: current.id || null,
          messages: current.msgs,
          mode: current.mode || 'general'
        })
      });
      const data = await res.json();
      setTyping(false);
      current.msgs.push({ text: data.message || data.reply, sender: 'bot' });

      // Guardar chat_id asignado si es chat nuevo
      if (!current.id && data.chat_id) {
        current.id = data.chat_id;
      }

      render();

      if (!current.title) {
        await generateTitle(current);
      }
    } catch {
      setTyping(false);
      current.msgs.push({ text: 'Error al conectar con el servidor.', sender: 'bot' });
      render();
    }
  };
  userInput.addEventListener('input', () => {
    sendBtn.disabled = userInput.value.trim().length === 0;

    // Autoajuste por renglón (no por cada letra)
    userInput.style.height = 'auto';
    const lineHeight = 24; // aproximadamente
    const lines = userInput.value.split('\n').length;
    const newHeight = Math.min(lines * lineHeight + 20, 200); // max 200px
    userInput.style.height = newHeight + 'px';
  });
  

  // Aquí está la función loadChats modificada como solicitaste
  async function loadChats() {
    try {
      const res = await fetch('/api/history');
      if (!res.ok) throw new Error('No history');
      const data = await res.json();

      if (Array.isArray(data.chats)) {
        chats = data.chats.map(chat => ({
          id: chat.id,
          title: chat.title || '',
          mode: chat.mode || 'general',
          msgs: chat.msgs || [],
          promptLocked: chat.promptLocked || chat.msgs.length > 1
        }));

        if (chats.length > 0) {
          select(chats[0]);
        } else {
          newChat();
        }
      } else {
        newChat();
      }
    } catch (err) {
      console.error('Error loading chats:', err);
      newChat();
    }
  }

  async function checkSession() {
    try {
      const res = await fetch('/api/session');
      if (!res.ok) throw new Error('No session');
      const data = await res.json();
      if (data.usuario) {
        loginArea.innerHTML = `<span style="color:#1e90ff; padding:1rem; font-size: 1rem;">Bienvenido, ${data.usuario}</span>`;
        await loadChats();
      } else {
        loginArea.innerHTML = `<a href="registro.html" class="login-link" target="_self" rel="noopener noreferrer">Login in</a>`;
        newChat();
      }
    } catch {
      loginArea.innerHTML = `<a href="registro.html" class="login-link" target="_self" rel="noopener noreferrer">Login in</a>`;
      newChat();
    }
  }
  checkSession();

</script>
</body>
</html>
